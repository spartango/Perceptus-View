<!DOCTYPE html>
<html>
<head>
<title>Test Viewer</title>
    <script src='wax/ext/modestmaps.js' type='text/javascript'></script>
    <script src='wax/dist/wax.mm.js' type='text/javascript'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js' type='text/javascript'></script>
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.2.1/css/bootstrap.css">
    <link rel='stylesheet' href='wax/theme/controls.css' type='text/css' />
    <link rel="stylesheet" type="text/css" href="css/boxselector.css" media="screen" />
</head>
    <body>
    <div id='image-map' style="height: 512px; width: 1024px;"></div>
    <div id='controls'>
        <div id='boxselector-text'></div>
        <div id='draw-toggle'> 
            <button class="btn btn-primary" type="button" onClick="createBoxSelector(); toggleButton();">Draw</button>
            <button class="btn-next" type="button" onClick="showNextImage(); toggleNextButton();">Next Image</button>
        </div>
    </div>
    <script type='text/javascript'>
        var boxselector;
        var resize = true;

        function toggleButton() {
             $('.btn').toggleClass('btn-success');
             resize = !resize;
        }

	function showNextImage() {
            tilejson = {
              tilejson: '1.0.0',
              scheme: 'xyz',
              tiles: ['http://c.tiles.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png'],
//          tiles: ['https://s3.amazonaws.com/testconvertedimagebucketserve/testImage/0/{x}/{y}'],
            };
            layer = new wax.mm.connector(tilejson);
	    m.addLayer(layer);
        }

        function callback(owner, box) {
            displayBox(owner, box, resize);
            if (!resize) {
                toggleButton();
            }
        }

        function createBoxSelector() {
            boxselector = new wax.mm.boxselector();
            boxselector.map(m);
            boxselector.add();
            boxselector.enable();
            boxselector.addCallback('change', callback);
        }

        function convertText(box) {
            var p1 = m.locationPoint(box[0]);
            var p2 = m.locationPoint(box[1]);
            return p1.toString() + p2.toString();
        }

        function addBox(owner, box) {
            var div = $('<div/>', {
                id : "coordinate" + owner.getId(),
                text: convertText(box)
            });
            div.appendTo('#boxselector-text');
        }

        function replaceBox(owner, box) {
            var obj = $('#coordinate' + owner.getId());
            console.log(obj);
            obj.text(box);
        }

        function displayBox(owner, box, isResize) {
            console.log(isResize);
            if (!isResize) {
                addBox(owner, box);
            } else { // resize
                replaceBox(owner, box);
            }
        }

        var tilejson = {
          tilejson: '1.0.0',
          scheme: 'xyz',
          tiles: ['https://s3.amazonaws.com/testconvertedimagebucketserve/testImage/0/{x}/{y}'],
        };

        // Setup the map
        var mm = com.modestmaps;
        var layer = new wax.mm.connector(tilejson);
        layer.provider.tileLimits = [ new mm.Coordinate(0,0,3), new mm.Coordinate(3,7,3) ];
        var m = new mm.Map('image-map');
        m.addLayer(layer);
        m.coordLimits = [ new mm.Coordinate(0,0,3), new mm.Coordinate(3,7,3) ];
        m.setZoom(3);

    </script>
    </body>
</html>
